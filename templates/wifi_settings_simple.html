<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Wi-Fi AyarlarÄ±</title>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--fg:#111;--accent:#111827}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:820px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.04);margin-bottom:16px}
    h1{margin:12px 0;text-align:center}
    h2{margin:12px 0 8px;font-size:18px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;justify-content:center;margin:10px 0}
    .radio{display:flex;gap:8px;align-items:center;cursor:pointer}
    select,input[type="text"],input[type="password"]{padding:10px 12px;border:1px solid var(--border);border-radius:10px;min-width:140px}
    input[type="password"]{min-width:200px}
    button{appearance:none;border:none;border-radius:10px;padding:10px 16px;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
    button:hover{opacity:0.9}
    .muted{color:var(--muted);font-size:14px;text-align:center}
    .toolbar{display:flex;gap:10px;justify-content:center;margin:10px 0}
    .divider{height:1px;background:var(--border);margin:16px 0}
    .flash-messages{max-width:820px;margin:0 auto 16px;padding:0 16px}
    .flash{padding:12px;border-radius:10px;margin-bottom:8px}
    .flash.success{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
    .flash.danger,.flash.error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
    .flash.warning,.flash.info{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
    .mode-toggle{display:flex;gap:16px;justify-content:center;margin:16px 0}
    .mode-btn{padding:12px 24px;border:2px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;font-weight:600;transition:all 0.2s}
    .mode-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .mode-btn:hover:not(.active){border-color:var(--accent)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="toolbar" style="margin-top:10px">
    <a href="{{ url_for('index') }}" style="text-decoration:none">
      â¬…ï¸ Video AkÄ±ÅŸÄ±na DÃ¶n
    </a>
  </div>

  <!-- Flash mesajlarÄ± -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="wrap">
    <h1>Wi-Fi AyarlarÄ±</h1>

    <!-- Mod SeÃ§ici (sadece sekme deÄŸiÅŸtirir; sistem modunu hemen deÄŸiÅŸtirmez) -->
    <div class="card">
      <h2>Wi-Fi Modu</h2>
      <div class="mode-toggle">
        <button type="button" id="btnAp" class="mode-btn {% if mode=='ap' %}active{% endif %}" onclick="showTab('ap')">
          ğŸ“¡ EriÅŸim NoktasÄ± (AP)
        </button>
        <button type="button" id="btnSta" class="mode-btn {% if mode=='sta' %}active{% endif %}" onclick="showTab('sta')">
          ğŸ“¶ Ä°stemci (STA)
        </button>
      </div>
      <p class="muted">
        Bu bÃ¶lÃ¼m sadece gÃ¶rÃ¼nÃ¼mÃ¼ deÄŸiÅŸtirir. STA modunda ayarlar, SSID ve ÅŸifreyi kaydettiÄŸinizde uygulanÄ±r.
      </p>
    </div>

    <!-- AP Modu AyarlarÄ± -->
    <div id="apSettings" class="{% if mode=='sta' %}hidden{% endif %}">
      <!-- Band ve Kanal AyarlarÄ± -->
      <div class="card">
        <h2>Bant ve Kanal AyarlarÄ±</h2>
        <form method="post" action="{{ url_for('apply_band_channel') }}">
          <!-- Bant -->
          <div class="row" style="margin-top:6px">
            <label class="radio">
              <input type="radio" name="band" value="2.4" {% if band=='2.4' %}checked{% endif %}> 2.4&nbsp;GHz
            </label>
            <label class="radio">
              <input type="radio" name="band" value="5" {% if band=='5' %}checked{% endif %}> 5&nbsp;GHz
            </label>
          </div>

          <!-- Kanal -->
          <div class="row">
            <label for="channel" class="muted" style="min-width:70px;text-align:right">Kanal</label>
            <select id="channel" name="channel"></select>
          </div>

          <!-- GÃ¶nder -->
          <div class="row" style="margin-top:8px">
            <button type="submit">Bant/Kanal Uygula</button>
          </div>

          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}
        </form>
      </div>

      <!-- AP Åifre DeÄŸiÅŸtirme -->
      <div class="card">
        <h2>AP Åifresi</h2>
        <form method="post" action="{{ url_for('apply_password') }}">
          <div class="row">
            <label for="current_pass" class="muted" style="min-width:100px;text-align:right">Mevcut Åifre</label>
            <input type="text" id="current_pass" value="{{ current_password }}" readonly style="background:#f3f4f6">
          </div>

          <div class="row">
            <label for="new_password" class="muted" style="min-width:100px;text-align:right">Yeni Åifre</label>
            <input type="password" id="new_password" name="password" placeholder="En az 8 karakter" required minlength="8" maxlength="63">
          </div>

          <div class="row" style="margin-top:8px">
            <button type="submit">Åifreyi GÃ¼ncelle</button>
          </div>

          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}
        </form>

        <p class="muted" style="margin-top:12px">
          Not: Åifre 8-63 karakter arasÄ±nda olmalÄ±dÄ±r. DeÄŸiÅŸiklik sonrasÄ± eriÅŸim noktasÄ± yeniden baÅŸlatÄ±lacaktÄ±r.
        </p>
      </div>
    </div>

    <!-- STA Modu AyarlarÄ± (yalnÄ±zca SSID/Åifre giriÅŸi) -->
    <div id="staSettings" class="{% if mode=='ap' %}hidden{% endif %}">
      <div class="card">
        <h2>Wi-Fi AÄŸÄ±na BaÄŸlan</h2>
        <form method="post" action="{{ url_for('connect_sta_network') }}">
          <div class="row">
            <label for="sta_ssid" class="muted" style="min-width:80px;text-align:right">SSID</label>
            <input type="text" id="sta_ssid" name="ssid" placeholder="AÄŸ adÄ±" required style="min-width:250px">
          </div>

          <div class="row">
            <label for="sta_password" class="muted" style="min-width:80px;text-align:right">Åifre</label>
            <input type="password" id="sta_password" name="password" placeholder="En az 8 karakter" required minlength="8">
          </div>

          <div class="row" style="margin-top:8px">
            <button type="submit">Kaydet ve BaÄŸlan</button>
          </div>

          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}
        </form>
        <p class="muted" style="margin-top:12px">
          Kaydetâ€™e bastÄ±ÄŸÄ±nÄ±zda AP modu kapanÄ±p cihaz seÃ§tiÄŸiniz aÄŸa baÄŸlanmaya Ã§alÄ±ÅŸacaktÄ±r. Bu esnada eriÅŸiminiz kesilebilir.
        </p>
      </div>
    </div>

    <p class="muted" style="margin-top:12px">
      Not: Mod deÄŸiÅŸikliÄŸi yalnÄ±zca ilgili ayarlar kaydedildiÄŸinde uygulanÄ±r.
    </p>
  </div>

  <script>
    const currentBand = "{{ band }}";
    const currentCh   = {{ channel|int }};
    const initialMode = "{{ mode }}"; // sunucudan gelen mevcut sistem modu

    const CHANNELS_24 = [{% for c in channels_24 %}{{ c }}{% if not loop.last %},{% endif %}{% endfor %}];
    const CHANNELS_5  = [{% for c in channels_5  %}{{ c }}{% if not loop.last %},{% endif %}{% endfor %}];

    const sel  = document.getElementById('channel');
    const band24 = document.querySelector('input[name="band"][value="2.4"]');
    const band5  = document.querySelector('input[name="band"][value="5"]');

    function fill(band, current){
      if (!sel) return;
      const list = band === '5' ? CHANNELS_5 : CHANNELS_24;
      sel.innerHTML = '';
      for (const c of list){
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        if (String(current) === String(c)) o.selected = true;
        sel.appendChild(o);
      }
    }

    // Ä°lk yÃ¼kleme
    fill(currentBand === '2.4' ? '2.4' : '5', currentCh || (currentBand === '2.4' ? 6 : 36));

    // Bant deÄŸiÅŸince kanal listesini yeniden doldur
    if(band24) band24.addEventListener('change', ()=> fill('2.4', 6));
    if(band5) band5.addEventListener('change', ()=> fill('5', 36));

    function showTab(mode){
      const ap = document.getElementById('apSettings');
      const sta = document.getElementById('staSettings');
      const btnAp = document.getElementById('btnAp');
      const btnSta = document.getElementById('btnSta');
      if (mode === 'ap'){
        ap.classList.remove('hidden');
        sta.classList.add('hidden');
        btnAp.classList.add('active'); btnSta.classList.remove('active');
      } else {
        sta.classList.remove('hidden');
        ap.classList.add('hidden');
        btnSta.classList.add('active'); btnAp.classList.remove('active');
      }
    }
  </script>
</body>
</html>
